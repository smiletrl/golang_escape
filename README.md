## Golang Escape Analysis

For programming, it's a good idea to use [stack allocation](https://en.wikipedia.org/wiki/Stack-based_memory_allocation), because stack allocation is [faster](https://stackoverflow.com/questions/161053/which-is-faster-stack-allocation-or-heap-allocation) than [heap allocation](https://en.wikipedia.org/wiki/Memory_management#DYNAMIC)

According to [Golang FAQ](https://golang.org/doc/faq#stack_or_heap), it's not very 
clear when a variable will be allocated at heap. Golang uses [Escape Analysis](https://github.com/golang/go/wiki/CompilerOptimizations#escape-analysis) to decide where a variable will be allocated.

This repository includes golang escape examples with real code samples. These examples could serve as a reference to write efficient golang code for high performance, i.e, avoid writing code like escape examples, or at least we know escaping to heap is a good trade-off for better reason if the decision is made to do the escape.

Result of this repository is based on go version: `go version go1.15.8 darwin/amd64`

To illustrate the basic idea, [inline optimization](https://github.com/golang/go/wiki/CompilerOptimizations#function-inlining) is mostly disabled in this repository.

### Commands to run

```
cd pkg/example1
go build -gcflags="-m -l" case1.go
```

An example result is like below:

```
smiletrl@Rulins-MacBook-Pro escape % go build -gcflags="-m -l" case1.go
# command-line-arguments
./case1.go:28:2: moved to heap: title
./case1.go:13:13: num escapes to heap
./case1.go:13:13: []interface {} literal does not escape
./case1.go:16:13: emp escapes to heap
./case1.go:16:13: []interface {} literal does not escape
<autogenerated>:1: .this does not escape
```

Note: `num escapes to heap` means `num` lives out of its own function scope, which doesn't necessarily mean `num` is allocated to heap. `moved to heap: title` means variable `title` is allocated at heap. The parameter `-l` is to disable inline optimization.

For a more verbose compile result, use double `-m` as `go build -gcflags="-m -m -l" case1.go`.

### Project Structure

```
github.com/smiletrl/golang_escape
|-- pkg
|   |-- example1
|   |   |-- README.md
|   |   |-- case1.go
|   |   |-- case2.go
|   |   |-- case3.go
|   |   |-- case4.go
|   |   |-- case5.go
|   |-- example2
|   |   |-- README.md
|   |   |-- case1.go
|   |   |-- case1_test.go
|   |   |-- profile001.png
|   |-- example3
|   |   |-- README.md
|   |   |-- case1.go
|   |   |-- case1_test.go
```

1. [example1](https://github.com/smiletrl/golang_escape/blob/master/pkg/example1/README.md) shows the pointer's value escaping.
2. [example2](https://github.com/smiletrl/golang_escape/blob/master/pkg/example2/README.md) shows the `large local variable` escaping.
3. [example3](https://github.com/smiletrl/golang_escape/blob/master/pkg/example3/README.md) shows the slice escaping.


Any feedback or new contributing examples are welcome :)
